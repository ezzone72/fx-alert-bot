name: fx-alert-bot

on:
  workflow_dispatch:
  schedule:
    # every 30 minutes
    - cron: "*/30 * * * *"

# ✅ push(커밋/푸시) 하려면 반드시 필요
permissions:
  contents: write

# ✅ 실행이 겹치면 알림이 중복될 수 있으니, 겹치기 방지(권장)
concurrency:
  group: fx-alert-bot
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install requests python-dotenv pillow
          fi

      - name: Run bot
        env:
          EXIMBANK_API_KEY: ${{ secrets.EXIMBANK_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          THRESHOLD: ${{ vars.THRESHOLD }}
        run: |
          python main.py

      # ✅ 핵심: state.json + data_*.csv 를 레포에 남겨서 "방향 전환 중복방지"가 다음 실행에도 유지되게 함
      - name: Persist state (csv + state.json)
        run: |
          git config user.name "fx-alert-bot"
          git config user.email "fx-alert-bot@users.noreply.github.com"

          # 없으면 만들어두기(첫 실행/첫 신호 대비)
          test -f state.json || echo "{}" > state.json

          # 통화별 CSV와 상태만 저장(이미지는 저장 안 함)
          git add state.json data_*.csv || true

          # 변경 없으면 커밋/푸시 생략
          git diff --cached --quiet && echo "No changes to commit" && exit 0

          git commit -m "Update fx state"
          git push
